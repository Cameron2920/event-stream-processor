<!-- app/views/metrics/dashboard.html.erb -->
<div class="metrics-dashboard">
  <h1>Event Processing Metrics</h1>

  <!-- Overview Cards -->
  <div class="overview-cards">
    <div class="metric-card">
      <h3>Total Events</h3>
      <p class="metric-value"><%= number_with_delimiter(@metrics[:overview][:total_events]) %></p>
    </div>

    <div class="metric-card">
      <h3>Avg Latency</h3>
      <p class="metric-value"><%= @metrics[:overview][:avg_latency] %> ms</p>
    </div>

    <div class="metric-card">
      <h3>P95 Latency</h3>
      <p class="metric-value"><%= @metrics[:overview][:p95_latency] %> ms</p>
    </div>

    <div class="metric-card">
      <h3>P99 Latency</h3>
      <p class="metric-value"><%= @metrics[:overview][:p99_latency] %> ms</p>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="charts-row">
    <!-- Hourly Events Chart -->
    <div class="chart-card">
      <h2>Events per Hour (Last 24h)</h2>
      <canvas id="hourly-chart"></canvas>
    </div>

    <!-- Events by Type Chart -->
    <div class="chart-card">
      <h2>Events by Type</h2>
      <canvas id="type-chart"></canvas>
    </div>
  </div>

  <!-- Latency Stats -->
  <div class="latency-stats">
    <h2>Latency Statistics</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <p class="stat-label">Min</p>
        <p class="stat-value"><%= @metrics[:latency][:min] %> ms</p>
      </div>
      <div class="stat-item">
        <p class="stat-label">P50</p>
        <p class="stat-value"><%= @metrics[:latency][:p50] %> ms</p>
      </div>
      <div class="stat-item">
        <p class="stat-label">Avg</p>
        <p class="stat-value"><%= @metrics[:latency][:avg] %> ms</p>
      </div>
      <div class="stat-item">
        <p class="stat-label">P95</p>
        <p class="stat-value"><%= @metrics[:latency][:p95] %> ms</p>
      </div>
      <div class="stat-item">
        <p class="stat-label">P99</p>
        <p class="stat-value"><%= @metrics[:latency][:p99] %> ms</p>
      </div>
      <div class="stat-item">
        <p class="stat-label">Max</p>
        <p class="stat-value"><%= @metrics[:latency][:max] %> ms</p>
      </div>
    </div>
  </div>

  <!-- Recent Events Table -->
  <div class="recent-events">
    <h2>Recent Events (Last 100)</h2>
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Occurred At</th>
        </tr>
        </thead>
        <tbody>
        <% @metrics[:recent_events].each do |event| %>
          <tr>
            <td><%= event['id'] %></td>
            <td><span class="event-type-badge"><%= event['type'] %></span></td>
            <td><%= event['occurred_at'] %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
    .metrics-dashboard {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .metrics-dashboard h1 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 2rem;
        color: #1a1a1a;
    }

    .metrics-dashboard h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1a1a1a;
    }

    /* Overview Cards */
    .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .metric-card h3 {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0 0 0.5rem 0;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #1a1a1a;
        margin: 0;
    }

    /* Charts */
    .charts-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .chart-card canvas {
        max-height: 300px;
    }

    /* Latency Stats */
    .latency-stats {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0 0 0.5rem 0;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1a1a1a;
        margin: 0;
    }

    /* Recent Events Table */
    .recent-events {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background-color: #f9fafb;
    }

    th {
        padding: 0.75rem 1.5rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e5e7eb;
    }

    td {
        padding: 1rem 1.5rem;
        font-size: 0.875rem;
        color: #1a1a1a;
        border-bottom: 1px solid #e5e7eb;
    }

    tbody tr:hover {
        background-color: #f9fafb;
    }

    .event-type-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: #dbeafe;
        color: #1e40af;
        border-radius: 9999px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .metrics-dashboard {
            padding: 1rem;
        }

        .charts-row {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        table {
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem;
        }
    }
</style>

<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    // Hourly Events Chart
    const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
    new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: <%= raw @metrics[:hourly].map { |h| h[:hour] }.to_json %>,
            datasets: [{
                label: 'Events',
                data: <%= raw @metrics[:hourly].map { |h| h[:count] }.to_json %>,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Events by Type Chart
    const typeCtx = document.getElementById('type-chart').getContext('2d');
    new Chart(typeCtx, {
        type: 'bar',
        data: {
            labels: <%= raw @metrics[:by_type].map { |t| t[:type] }.to_json %>,
            datasets: [{
                label: 'Count',
                data: <%= raw @metrics[:by_type].map { |t| t[:count] }.to_json %>,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(139, 92, 246, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Auto-refresh every 5 seconds
    setTimeout(function() {
        location.reload();
    }, 5000);
</script>